name: (reusable) Build - Windows setup.exe

on:
  workflow_call:
    inputs:
      version:
        description: 'Version string (e.g., 0.1.2)'
        required: true
        type: string

jobs:
  windows_setup_exe:
    name: Windows (setup.exe)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: 911218sky/flutter-action@v1
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Build windows
        run: flutter build windows --release --split-debug-info=build/symbols --obfuscate

      - name: Install Inno Setup (winget; fallback to choco)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          $existing = (Get-Command ISCC.exe -ErrorAction SilentlyContinue | ForEach-Object Source | Select-Object -First 1)
          if (-not $existing) {
            $candidates = @(
              "$env:ProgramFiles(x86)\Inno Setup 6\ISCC.exe",
              "$env:ProgramFiles\Inno Setup 6\ISCC.exe",
              "$env:ChocolateyInstall\bin\ISCC.exe",
              "$env:LOCALAPPDATA\Programs\Inno Setup 6\ISCC.exe"
            ) | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1
            $existing = $candidates
          }
          if ($existing) {
            Write-Host "ISCC.exe already exists at: $existing (skip install)"
            $ErrorActionPreference = 'Stop'
            exit 0
          }

          winget install --id JRSoftware.InnoSetup --source winget --accept-source-agreements --accept-package-agreements --silent
          if ($LASTEXITCODE -ne 0) {
            Write-Host "winget install failed (exit=$LASTEXITCODE). Trying choco..."
            choco install innosetup -y
          }
          $ErrorActionPreference = 'Stop'

      - name: Build setup.exe (Inno Setup, generate .iss inline)
        shell: pwsh
        env:
          APP_VERSION: ${{ inputs.version }}
        run: |
          $ErrorActionPreference = 'Stop'

          $releaseDir = Join-Path $PWD 'build\windows\x64\runner\Release'
          if (-not (Test-Path $releaseDir)) { throw "Windows release output not found: $releaseDir" }

          $mainExe = Get-ChildItem $releaseDir -Filter *.exe -File |
            Where-Object { $_.Name -notmatch 'flutter_tester' } |
            Select-Object -First 1
          if (-not $mainExe) { throw "No .exe found under: $releaseDir" }

          $iscc = (Get-Command ISCC.exe -ErrorAction SilentlyContinue | ForEach-Object Source | Select-Object -First 1)
          if (-not $iscc) {
            $candidates = @(
              "$env:ProgramFiles(x86)\Inno Setup 6\ISCC.exe",
              "$env:ProgramFiles\Inno Setup 6\ISCC.exe",
              "$env:ChocolateyInstall\bin\ISCC.exe",
              "$env:LOCALAPPDATA\Programs\Inno Setup 6\ISCC.exe"
            )
            $iscc = $candidates | Where-Object { $_ -and (Test-Path $_) } | Select-Object -First 1
          }
          if (-not $iscc) { throw "ISCC.exe not found after installation." }

          $appVersion = $env:APP_VERSION
          Write-Host "Using version: $appVersion"

          $appName = 'Gait Charts'
          $publisher = 'NYCU'
          $iconIco = Join-Path $PWD 'windows\runner\resources\app_icon.ico'
          if (-not (Test-Path $iconIco)) { $iconIco = $null }

          New-Item -ItemType Directory -Force -Path dist | Out-Null
          $issPath = Join-Path $PWD 'dist\gait_charts_setup.iss'

          $iconLine = ""
          if ($iconIco) { $iconLine = "SetupIconFile=$iconIco`r`n" }

          $issLines = @(
            '; Auto-generated by GitHub Actions workflow.',
            '',
            '[Setup]',
            "AppName=$appName",
            "AppVersion=$appVersion",
            "AppPublisher=$publisher",
            "DefaultDirName={autopf}\$appName",
            "DefaultGroupName=$appName",
            "OutputDir=$PWD\dist",
            "OutputBaseFilename=GaitCharts_Setup_v$appVersion",
            'Compression=lzma2',
            'SolidCompression=yes',
            'DisableProgramGroupPage=yes',
            "UninstallDisplayIcon={app}\$($mainExe.Name)"
          )

          if ($iconLine) {
            $issLines += ($iconLine -split "`r?`n" | Where-Object { $_ -ne '' })
          }

          $issLines += @(
            '',
            '[Languages]',
            'Name: "en"; MessagesFile: "compiler:Default.isl"',
            '',
            '[Tasks]',
            'Name: "desktopicon"; Description: "Create a &desktop icon"; GroupDescription: "Additional icons:"; Flags: unchecked',
            '',
            '[Files]',
            "Source: ""$releaseDir\*""; DestDir: ""{app}""; Flags: ignoreversion recursesubdirs createallsubdirs",
            '',
            '[Icons]',
            "Name: ""{group}\$appName""; Filename: ""{app}\$($mainExe.Name)""",
            "Name: ""{autodesktop}\$appName""; Filename: ""{app}\$($mainExe.Name)""; Tasks: desktopicon",
            '',
            '[Run]',
            "Filename: ""{app}\$($mainExe.Name)""; Description: ""Launch $appName""; Flags: nowait postinstall skipifsilent"
          )

          $iss = ($issLines -join "`r`n")

          [System.IO.File]::WriteAllText(
            $issPath,
            $iss,
            (New-Object System.Text.UTF8Encoding($true))
          )

          & $iscc $issPath | Out-Host
          if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }

          $outExe = Join-Path $PWD "dist\GaitCharts_Setup_v$appVersion.exe"
          if (-not (Test-Path $outExe)) { throw "Expected output not found: $outExe" }

      - name: Upload artifact (windows dist)
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows
          path: dist/GaitCharts_Setup_v*.exe
          if-no-files-found: error