name: Trigger Realsense Pose Build

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.1.3)'
        required: true
        default: ''
  workflow_run:
    workflows: ["Build & Release (Web / Windows setup.exe / Android APK / Linux / macOS)"]
    types:
      - completed
    branches:
      - main

jobs:
  trigger:
    runs-on: ubuntu-latest
    # Run if: manual trigger OR (build succeeded AND triggered by tag)
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       startsWith(github.event.workflow_run.head_branch, 'v'))
    steps:
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.workflow_run.head_branch }}" >> $GITHUB_OUTPUT
          fi

      - name: Trigger realsense-pose Docker build
        run: |
          echo "Triggering realsense-pose build for version: ${{ steps.version.outputs.tag }}"
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.REALSENSE_POSE_PAT }}" \
            https://api.github.com/repos/911218sky/realsense-pose/dispatches \
            -d '{"event_type":"gait-charts-release","client_payload":{"version":"${{ steps.version.outputs.tag }}"}}'