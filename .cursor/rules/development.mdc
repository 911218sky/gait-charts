---
description: Gait Charts Dashboard 開發規範 (Cursor Rules)
alwaysApply: true
---

Gait Charts Dashboard 開發規範（Cursor Rules）

> 目標：讓後續開發者（與 Cursor/AI）在不看所有歷史脈絡的前提下，也能**穩定地**延伸功能、保持 UI/架構一致、避免效能與狀態管理踩雷。

---

## 最重要的三條（違反就視為不合格）

1. **分層不可破**：`domain` 放規則/計算/模型，`data` 放 IO/HTTP，`presentation` 放畫面與互動。
2. **Riverpod 3 是唯一狀態管理**：不要引入其他 state management library。
3. **不要在 `build()` 內做重工/副作用**：重計算、JSON parse、排序聚合、showSnackBar、navigation…都不該在 `build()` 觸發。

---

## 文案 / 註解語言

- **以繁體中文為主**（註解、UI 文案、README）。
- 技術名詞可保留英文：`session`, `lap`, `offset`, `payload`, `debounce`。

---

## 目錄與分層慣例（準 DDD / feature-based）

### `lib/app/`（App 等級）

- `app.dart`：`MaterialApp`、theme mode、home 入口
- `theme.dart`：全域 Theme、ThemeExtension、`ThemeContextExtension`
- **新增全域 UI/設定**：優先放在 `lib/app`（不要塞進某個 feature）

### `lib/core/`（可重用共用層）

- `config/`：跨 feature 的設定（例如 `AppConfig`）
- `network/`：`dioProvider`、API retry、例外映射（例如 `withApiRetry`, `mapDioError`）
- `providers/`：全域 provider（不要放 feature-specific provider）
- `widgets/`：跨 feature 共用 UI（例如 `AsyncRequestView`）

### `lib/features/<feature>/`（功能模組）

- `data/`：API service、repository（只做 delegate + 輕量轉換）
- `domain/`：純模型、config class、計算邏輯（不得依賴 Flutter/UI）
- `presentation/`：
  - `providers/`：Riverpod Notifier / AsyncNotifier、衍生 provider
  - `views/`：大畫面組裝
  - `widgets/`：小組件

**依賴方向（強制）**：
- `presentation` → 可依賴 `domain`、`data`
- `data` → 可依賴 `domain`、`core`
- `domain` → **不得**依賴 Flutter / UI
- `core` → 不放單一 feature 的 business rule

---

## Network / API 規範（Dio）

- **禁止**在 UI 直接建立 Dio：不要 `Dio()`、不要在 widget 裡處理 `DioException`。
- **統一透過 `dioProvider`**（位於 `lib/core/network/api_client.dart`）。
- **錯誤映射**：使用 `mapDioError`（`lib/core/network/api_exception.dart`），讓 UI 只看到可讀訊息。
- **重試**：service 層呼叫 API 時優先包 `withApiRetry(...)`（同樣在 `api_client.dart`）。

`AppConfig`：
- 預設 `baseUrl` 在 `lib/core/config/app_config.dart` 的 `defaultAppConfig`
- 透過 `lib/core/providers/app_config_provider.dart` 注入（未來若要做環境變數覆寫，從這裡做）

---

## Riverpod 3 規範（Provider 設計）

### Provider 放置位置（強制）

- App 全域：`lib/app` 或 `lib/core/providers`
- Feature 專屬：`lib/features/<feature>/presentation/providers`
- `data` 層的 repository provider：放在 `data/` 或 `presentation/providers` 的「靠近使用端」位置，但**不要**放到 `core`

### 命名慣例（建議但盡量遵守）

- 一律以 `...Provider` 結尾
- Notifier：`XxxNotifier` / `XxxStateNotifier`（視專案既有命名而定）
- Barrel export：提供 `<feature>_providers.dart` 統一 export（維持 dashboard 的 pattern）

### AsyncValue/錯誤處理（強制）

- UI 顯示 async 狀態：**優先使用** `AsyncRequestView`
- 不要在 UI `catch` Dio 例外；資料錯誤應在 data/service 層轉成 `ApiException` 等 domain-friendly 的 error
- 避免 error-loop：既有專案有「failure gate」機制（若 feature 有使用，請沿用既有 pattern；不要在 UI 自己寫 retry loop）

### 副作用（Side effects）

- **禁止**在 `build()` 顯示 SnackBar / navigation / 寫入狀態
- 用 `ref.listen(...)` / `ref.listenManual(...)` 或在 Notifier action 回傳結果後由 UI 觸發

### Debounce / throttle（效能）

- 使用既有 `core/config/debounce_config.dart` 或沿用 dashboard 內既有 Timer + `ref.onDispose` pattern
- 避免高頻輸入造成連續 API hit

---

## UI / Theme（深色 Vercel 風格）

### 主題使用（強制）

- 深色為預設（`ThemeMode.dark`）
- 取 Theme 優先使用 `ThemeContextExtension`（例如 `context.colorScheme`、`context.theme`）
- **禁止**在非 theme 檔案硬編顏色常數（除非你在 `lib/app/theme.dart` 擴充 Theme/ThemeExtension）

### 組件與版面

- 儀表板寬度切換：
  - 寬螢幕：`NavigationRail` / `SidebarNavigation`
  - 小螢幕：`NavigationBar`
- 卡片：優先用 `Card` + theme 的 `cardTheme`；圓角 6–8（或依現有元件設定）
- 互動回饋：
  - 成功：`ScaffoldMessenger.of(context).showSnackBar(...)` 或既有 `DashboardToast`
  - 失敗：`AsyncErrorView` / `AsyncRequestView`（不要讓錯誤只出現在 console）
- 動畫：`AnimatedSwitcher` 等輕量，150–300ms

---

## Domain model / 計算規範

- 模型盡量 immutable：`final` 欄位，`const` 建構子優先
- JSON model：`factory Xxx.fromJson`，在內部做型別防呆（不要把脆弱的 parse 放 UI）
- **任何資料聚合/排序/filter/統計**：放在 `domain` 或 provider（衍生 provider）中，避免 widget 重 build 重算

---

## 程式碼風格（flutter_lints）

- 2-space 縮排、能 `const` 就 `const`
- collection / widget 多行結尾逗號保留
- 檔名：`snake_case.dart`
- 註解：簡短繁中；對外 API 用 `///` 寫清楚單位、邊界條件

---

## 新增/修改功能時的標準流程（建議照做）

1. **先定位 feature**：屬於 `dashboard` 既有功能？還是要新增 `lib/features/<new_feature>`？
2. **先做 domain**：模型/計算/設定（`copyWith`、`toJson`）
3. **再做 data**：API service（用 `dioProvider` + `withApiRetry` + `mapDioError`）→ repository（delegate + 輕量轉換）
4. **最後做 presentation**：provider（Notifier/AsyncNotifier/衍生 provider）→ view/widget（`AsyncRequestView`）
5. **避免破壞既有 pattern**：先找 dashboard 內同類型的 provider/view 寫法再擴充

---

## 變更前自我檢查（Checklist）

- **架構**：domain/data/presentation 邊界清楚？domain 沒有依賴 Flutter？
- **狀態**：provider 放對位置？命名一致？沒在 `build()` 觸發副作用？
- **網路**：沒有在 UI new Dio？錯誤有經過 `mapDioError`？有需要的 retry/timeout？
- **UI/Theme**：沒有硬編顏色？使用 `context.colorScheme` / ThemeExtension？深/淺色都看起來 OK？
- **效能**：沒有在 `build()` 做 JSON parse/聚合/排序？有用 `select` 降低 rebuild？
- **測試**：新增計算/解析或修 bug，有補最小單元測試（放 `test/`）？
