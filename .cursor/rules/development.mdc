---
description: Gait Charts dashboard development guidelines
alwaysApply: true
---

# Gait Charts Dashboard Development Guidelines

> Enable AI and developers to extend features consistently without reading full history, maintaining UI/architecture consistency and avoiding performance/state management pitfalls.

## ğŸš¨ Core Principles (Violations = Unacceptable)

1. **Layer Separation is Sacred**: `domain` = rules/calculations/models, `data` = IO/HTTP, `presentation` = UI & interactions
2. **Riverpod 3 Only**: No other state management libraries allowed
3. **No Side Effects in build()**: No recalculations, JSON parsing, sorting, aggregation, showSnackBar, or navigation in `build()`

## ğŸŒ Language Guidelines

- Comments, UI text, README in **Traditional Chinese**
- Keep technical terms in English: `session`, `lap`, `offset`, `payload`, `debounce`

## ğŸ“ Directory Structure (DDD / Feature-based)

```
lib/
â”œâ”€â”€ app/                    # App-level (MaterialApp, theme, home entry)
â”œâ”€â”€ core/                   # Reusable shared layer
â”‚   â”œâ”€â”€ config/             # Cross-feature config (AppConfig)
â”‚   â”œâ”€â”€ network/            # dioProvider, API retry, exception mapping
â”‚   â”œâ”€â”€ providers/          # Global providers
â”‚   â””â”€â”€ widgets/            # Cross-feature shared UI (AsyncRequestView)
â””â”€â”€ features/<feature>/     # Feature modules
    â”œâ”€â”€ data/               # API service, repository
    â”œâ”€â”€ domain/             # Pure models, calculation logic (no Flutter dependency)
    â””â”€â”€ presentation/
        â”œâ”€â”€ providers/      # Notifier / AsyncNotifier
        â”œâ”€â”€ views/          # Large view compositions
        â””â”€â”€ widgets/        # Small components
```

### ğŸ”— Dependency Direction (Enforced)

| Direction | Allowed |
|-----------|---------|
| `presentation` â†’ `domain`, `data` | âœ… |
| `data` â†’ `domain`, `core` | âœ… |
| `domain` â†’ Flutter / UI | âŒ |
| `core` â†’ Single feature business rule | âŒ |

## ğŸŒ Network Guidelines (Dio)

| Rule | Description |
|------|-------------|
| âŒ Forbidden | UI directly using `Dio()` or handling `DioException` |
| âœ… Use | `dioProvider` (`lib/core/network/api_client.dart`) |
| âœ… Errors | `mapDioError` (`lib/core/network/api_exception.dart`) |
| âœ… Retry | `withApiRetry(...)` |
| âœ… Base URL | `lib/core/config/app_config.dart` |

## ğŸ”„ Riverpod Guidelines

### ğŸ“ Placement

| Type | Location |
|------|----------|
| Global | `lib/app` or `lib/core/providers` |
| Feature-specific | `lib/features/<feature>/presentation/providers` |

### ğŸ“ Naming

- Providers end with `...Provider`
- Notifiers end with `...Notifier`
- Provide `<feature>_providers.dart` barrel export

### âš ï¸ Error Handling

- UI async state uses `AsyncRequestView`
- Don't catch Dio exceptions in UI; convert to `ApiException` in data layer
- Handle side effects with `ref.listen()`, not in `build()`

## ğŸ¨ UI / Theme

| Rule | Description |
|------|-------------|
| Default | Dark mode (`ThemeMode.dark`) |
| Colors | Use `context.colorScheme`, `context.theme` (ThemeContextExtension) |
| âŒ Forbidden | Hardcoded color constants (except in `lib/app/theme.dart`) |
| Wide screen | `NavigationRail` |
| Small screen | `NavigationBar` |
| Animations | 150â€“300ms |

### ğŸ¯ Dark Theme Style Guidelines

This project uses a unified dark UI style. All new components should follow these design specifications:

#### Background Color Hierarchy (Dark Mode)

| Level | Color Code | Usage |
|-------|------------|-------|
| Deepest | `#0A0A0A` | Dialog background, main container background |
| Dark | `#111111` | Card background, input field background, list items |
| Medium | `#1A1A1A` | Icon containers, secondary button background, hover state |
| Light | `#222222` | Dividers, disabled state background |

#### Border Radius Specifications

| Component Type | Border Radius |
|----------------|---------------|
| Dialog | `12px` |
| Card (Grid Card) | `12px` |
| Button | `8px` |
| Input Field | `8px` |
| Icon Container | `8px` ~ `10px` |
| Badge / Tag | `6px` ~ `8px` |

#### Dialog Design Specifications

```dart
Dialog(
  backgroundColor: isDark ? const Color(0xFF0A0A0A) : colors.surfaceContainer,
  shape: RoundedRectangleBorder(
    borderRadius: BorderRadius.circular(12),
    side: BorderSide(color: colors.outlineVariant),
  ),
)
```

- Header: 24px padding, title uses `GoogleFonts.inter` 18-20px bold
- Content: 24px horizontal padding
- Footer: 24px padding, buttons aligned to the right

#### Card Design Specifications (Grid Card)

```dart
Material(
  color: isDark ? const Color(0xFF111111) : colors.surfaceContainerLow,
  shape: RoundedRectangleBorder(
    borderRadius: BorderRadius.circular(12),
    side: BorderSide(
      color: isSelected ? colors.primary : colors.outlineVariant,
      width: isSelected ? 2 : 1,
    ),
  ),
  clipBehavior: Clip.antiAlias,
)
```

- Internal padding: 16px
- Icon container: 32-44px square, background `#1A1A1A`
- Title: 15px bold
- Subtitle / Stats: 12px, use `colors.onSurfaceVariant`

#### Button Design Specifications

```dart
// Filled Button (Primary Action)
FilledButton.styleFrom(
  padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 18),
  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
)

// Outlined Button (Secondary Action)
OutlinedButton.styleFrom(
  foregroundColor: colors.onSurface,
  side: BorderSide(color: colors.outlineVariant),
  padding: const EdgeInsets.symmetric(horizontal: 14, vertical: 14),
  shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(8)),
)
```

#### Input Field Design Specifications

```dart
Container(
  decoration: BoxDecoration(
    color: isDark ? const Color(0xFF111111) : colors.surfaceContainerLow,
    borderRadius: BorderRadius.circular(8),
    border: Border.all(color: colors.outlineVariant),
  ),
)
```

#### Typography Specifications

- Use `GoogleFonts.inter` for consistency
- Title: 18-20px, `FontWeight.w700`
- Subtitle: 13-14px, `FontWeight.w500`
- Body: 14-15px
- Label / Badge: 11-13px, `FontWeight.w600`

#### Status Badge Design

```dart
Container(
  padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 6),
  decoration: BoxDecoration(
    color: statusColor.withValues(alpha: 0.15),
    borderRadius: BorderRadius.circular(8),
    border: Border.all(color: statusColor.withValues(alpha: 0.4), width: 1.5),
  ),
)
```

#### List Item Design

```dart
Material(
  color: isDark ? const Color(0xFF111111) : colors.surfaceContainerLow,
  shape: RoundedRectangleBorder(
    borderRadius: BorderRadius.circular(12),
    side: BorderSide(color: colors.outlineVariant),
  ),
  child: InkWell(
    borderRadius: BorderRadius.circular(12),
    hoverColor: colors.onSurface.withValues(alpha: 0.05),
    // ...
  ),
)
```

#### Reference Implementation Files

- Dialog example: `lib/features/dashboard/presentation/widgets/cohort_benchmark/cohort_selector_dialog.dart`
- Delete confirmation dialog: `lib/features/dashboard/presentation/widgets/cohort_benchmark/delete_cohort_benchmark_dialog.dart`
- Grid Card example: `lib/features/dashboard/presentation/widgets/shared/cards/session_grid_card.dart`
- Status badge: `lib/features/dashboard/presentation/widgets/cohort_benchmark/metric_status_badge.dart`

## ğŸ“¦ Domain Model

- **Immutable**: `final` fields, prefer `const` constructors
- **JSON**: `factory Xxx.fromJson` with internal type safety
- **Aggregation/sorting/filter**: Place in `domain` or derived providers

## ğŸ’» Code Style

| Rule | Description |
|------|-------------|
| Indentation | 2-space |
| Constants | Use `const` whenever possible |
| Trailing commas | Keep for multi-line |
| File names | `snake_case.dart` |
| Public API | Use `///` doc comments |

## ğŸ“ Comment Guidelines

Write comments like a human developer would - concise, practical, and helpful. Avoid robotic or overly formal language.

### Comment Language

- **UI text, user-facing strings**: Traditional Chinese
- **Code comments**: Traditional Chinese (keep technical terms in English)
- **Doc comments (`///`)**: Traditional Chinese

### Good Comment Principles

1. **Explain "why", not "what"** - The code shows what it does; comments explain the reasoning
2. **Be concise** - One line is often enough
3. **Use natural language** - Write like you're explaining to a colleague
4. **Avoid obvious comments** - Don't comment self-explanatory code

### Comment Examples

```dart
// âœ… Good: Explains the reasoning
// å¾Œç«¯é è¨­å›å‚³ UTCï¼Œé€™è£¡è½‰æˆæœ¬åœ°æ™‚é–“æ–¹ä¾¿é¡¯ç¤º
final localTime = utcTime.toLocal();

// âœ… Good: Warns about edge cases
// æ³¨æ„ï¼šcohort å¯èƒ½ç‚ºç©ºé™£åˆ—ï¼Œéœ€è¦ fallback åˆ°é è¨­å€¼
final cohort = user.cohort.isNotEmpty ? user.cohort : ['æ­£å¸¸äºº'];

// âœ… Good: Explains business logic
// åªæœ‰ session æœ‰å½±ç‰‡æ™‚æ‰é¡¯ç¤ºæ’­æ”¾æŒ‰éˆ•
if (session.hasVideo) { ... }

// âœ… Good: Documents non-obvious behavior
// API å›å‚³çš„ page æ˜¯ 1-basedï¼Œä½† UI ç”¨ 0-based index
final pageIndex = response.page - 1;

// âŒ Bad: States the obvious
// è¨­å®š isLoading ç‚º true
setState(() => _isLoading = true);

// âŒ Bad: Too verbose / robotic
// This function is responsible for fetching the user data from the API
// and returning it as a UserItem object for use in the presentation layer.
Future<UserItem> fetchUser() { ... }
```

### Doc Comment Style (`///`)

```dart
/// ä½¿ç”¨è€…æ—ç¾¤é¸æ“‡å°è©±æ¡†ã€‚
///
/// ä»¥ Grid æ–¹å¼é¡¯ç¤ºæ‰€æœ‰å¯ç”¨æ—ç¾¤ï¼Œé»é¸å¾Œå›å‚³é¸ä¸­çš„ cohort åç¨±ã€‚
/// è‹¥ä½¿ç”¨è€…å–æ¶ˆå‰‡å›å‚³ nullã€‚
class CohortSelectorDialog extends ConsumerStatefulWidget { ... }

/// è¨ˆç®— BMI å€¼ã€‚
///
/// [heightCm] èº«é«˜ï¼ˆå…¬åˆ†ï¼‰ï¼Œ[weightKg] é«”é‡ï¼ˆå…¬æ–¤ï¼‰ã€‚
/// å›å‚³ BMI å€¼ï¼Œè‹¥è¼¸å…¥ç„¡æ•ˆå‰‡å›å‚³ nullã€‚
double? calculateBmi(double? heightCm, double? weightKg) { ... }

/// å¾ JSON è§£æä½¿ç”¨è€…è³‡æ–™ã€‚
///
/// å…§éƒ¨æœƒè™•ç†å‹åˆ¥è½‰æ›èˆ‡é è¨­å€¼ï¼Œå‘¼å«ç«¯ä¸éœ€é¡å¤–æª¢æŸ¥ã€‚
factory UserItem.fromJson(Map<String, Object?> json) { ... }
```

### Inline Comment Placement

```dart
// âœ… Good: Comment on its own line, above the code
// å…ˆæª¢æŸ¥å¿«å–ï¼Œé¿å…é‡è¤‡è«‹æ±‚
final cached = _cache[key];
if (cached != null) return cached;

// âœ… Good: Short comment at end of line for simple cases
final isDark = context.isDark; // åˆ¤æ–·æ·±è‰²æ¨¡å¼

// âŒ Bad: Long comment at end of line
final result = await api.fetch(); // é€™å€‹ API æœƒå›å‚³ä½¿ç”¨è€…è³‡æ–™ï¼ŒåŒ…å« sessions åˆ—è¡¨å’ŒåŸºæœ¬è³‡è¨Š
```

### Section Comments in Large Files

```dart
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Header
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Content
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Footer
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### TODO Comments

```dart
// TODO: ä¹‹å¾Œè¦åŠ ä¸Šåˆ†é åŠŸèƒ½
// TODO(username): ç­‰å¾Œç«¯ API æ›´æ–°å¾Œç§»é™¤é€™å€‹ workaround
// FIXME: é€™è£¡æœ‰ race conditionï¼Œéœ€è¦åŠ  debounce
```

## ğŸ”„ Development Workflow

1. Identify feature (existing or new)
2. Start with domain (models/calculations)
3. Then data (API service â†’ repository)
4. Finally presentation (provider â†’ view/widget)
5. Reference existing patterns before extending

## âœ… Pre-Change Checklist

- [ ] domain/data/presentation boundaries are clear
- [ ] Provider placement and naming are correct
- [ ] No side effects triggered in `build()`
- [ ] Network errors go through `mapDioError`
- [ ] No hardcoded colors
- [ ] No heavy calculations in `build()`
- [ ] New logic has unit tests
