{
  "enabled": true,
  "name": "Merge to Main",
  "description": "Safely merges current branch to main with pre-merge checks, conflict resolution, and automatic push.",
  "version": "1",
  "when": {
    "type": "userTriggered"
  },
  "then": {
    "type": "askAgent",
    "prompt": "Merge current branch to main branch safely. Execute immediately without confirmation.\n\n## ğŸ” Step 1: Pre-Merge Checks\n\n1. Run `git status` to check for uncommitted changes\n2. Run `git branch --show-current` to get current branch name\n3. If uncommitted changes exist:\n   - Ask user: \"Uncommitted changes detected. Commit first or stash?\"\n   - If commit: trigger commit workflow\n   - If stash: `git stash push -m \"Auto-stash before merge\"`\n\n### Validation Rules:\n| Check | Command | Fail Action |\n|-------|---------|-------------|\n| Not on main | `git branch --show-current` | Proceed if not 'main' |\n| Clean working tree | `git status --porcelain` | Stash or commit |\n| Branch exists | `git rev-parse --verify HEAD` | Abort if invalid |\n\n## ğŸ“¥ Step 2: Sync with Remote\n\n1. Fetch latest changes:\n   ```\n   git fetch origin main\n   git fetch origin <current-branch>\n   ```\n\n2. Update current branch if behind:\n   ```\n   git pull --rebase origin <current-branch>\n   ```\n\n3. Check if main has new commits:\n   ```\n   git log HEAD..origin/main --oneline\n   ```\n\n## ğŸ”€ Step 3: Merge Strategy\n\n### Option A: Fast-Forward (Preferred)\nIf main hasn't diverged:\n```\ngit checkout main\ngit merge <branch> --ff-only\n```\n\n### Option B: Merge Commit\nIf fast-forward not possible:\n```\ngit checkout main\ngit pull origin main\ngit merge <branch> --no-ff -m \"ğŸ”€ merge(<branch>): Merge <branch> into main\"\n```\n\n### Merge Commit Format:\n```\nğŸ”€ merge(<branch>): <summary>\n\nMerged from: <branch>\nCommits included:\n- <commit1>\n- <commit2>\n```\n\n## âš ï¸ Step 4: Conflict Resolution\n\nIf conflicts occur:\n\n1. List conflicted files:\n   ```\n   git diff --name-only --diff-filter=U\n   ```\n\n2. For each conflict:\n   - Show conflict markers\n   - Analyze both versions\n   - Suggest resolution based on:\n     - Newer timestamp wins for config files\n     - Preserve both for feature code\n     - Ask user for critical files\n\n3. After resolution:\n   ```\n   git add <resolved-files>\n   git commit -m \"ğŸ”§ fix(merge): Resolve conflicts from <branch>\"\n   ```\n\n## ğŸ“¤ Step 5: Push to Remote\n\n1. Push main to remote:\n   ```\n   git push origin main\n   ```\n\n2. Handle push failures:\n   | Error | Solution |\n   |-------|----------|\n   | Remote ahead | `git pull --rebase origin main` â†’ retry |\n   | Protected branch | Notify user to create PR instead |\n   | Auth error | Notify user to check credentials |\n\n## ğŸ§¹ Step 6: Cleanup (Optional)\n\nAsk user if they want to:\n\n1. Delete merged branch locally:\n   ```\n   git branch -d <branch>\n   ```\n\n2. Delete merged branch remotely:\n   ```\n   git push origin --delete <branch>\n   ```\n\n3. Restore stashed changes (if any):\n   ```\n   git checkout <branch> (if not deleted)\n   git stash pop\n   ```\n\n## ğŸ“Š Output Summary\n\nAfter completion, show:\n```\nâœ… Merge Complete!\n\nğŸ“Œ Branch: <branch> â†’ main\nğŸ“ Merge Type: Fast-forward / Merge commit\nğŸ”¢ Commits Merged: X\nğŸ“¤ Pushed: origin/main\nğŸ—‘ï¸ Cleanup: Branch deleted / kept\n\nğŸ“‹ Commits Included:\n   - <emoji> <commit1>\n   - <emoji> <commit2>\n```\n\n## âŒ Abort Conditions\n\nAbort merge and notify user if:\n- Current branch is already 'main'\n- Unresolvable conflicts (binary files, complex merges)\n- Protected branch rules prevent direct push\n- Network/authentication errors\n\nOn abort:\n```\ngit merge --abort\ngit checkout <original-branch>\ngit stash pop (if stashed)\n```"
  }
}
